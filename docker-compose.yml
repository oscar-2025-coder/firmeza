services:

  # ========================================
  #  FIRMEZA TESTS (xUnit - Gatekeeper)
  # ========================================
  firmeza-tests:
    build:
      context: .
      dockerfile: Firmeza.Tests/Dockerfile
    container_name: firmeza-tests
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
    # Essential: Deployment stops if this service fails (exit code != 0)
    
  # ========================================
  #  DATABASE (PostgreSQL)
  # ========================================
  db:
    image: postgres:15-alpine
    container_name: firmeza-db
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-firmeza_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    depends_on:
      firmeza-tests:
        condition: service_completed_successfully

  # ========================================
  #  FIRMEZA API (REST API)
  # ========================================
  firmeza-api:
    build:
      context: .
      dockerfile: Firmeza.Api/Dockerfile
    container_name: firmeza-api
    ports:
      - "8081:8080"   # Swagger: http://localhost:8081/swagger
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      # Update connection string to point to the 'db' container
      DB_CONNECTION: "Host=db;Port=5432;Database=${DB_NAME:-firmeza_db};Username=${DB_USER:-postgres};Password=${DB_PASSWORD:-postgres}"
      JWT_KEY: ${JWT_KEY}
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_EMAIL: ${SMTP_EMAIL}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_ENABLE_SSL: ${SMTP_ENABLE_SSL}
    depends_on:
      firmeza-tests:
        condition: service_completed_successfully
      db:
        condition: service_started

  # ========================================
  #  FIRMEZA ADMIN (Razor / Panel)
  # ========================================
  firmeza-admin:
    build:
      context: .
      dockerfile: Firmeza.Admin/Dockerfile
    container_name: firmeza-admin
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      # Update connection string to point to the 'db' container
      DB_CONNECTION: "Host=db;Port=5432;Database=${DB_NAME:-firmeza_db};Username=${DB_USER:-postgres};Password=${DB_PASSWORD:-postgres}"
    depends_on:
      firmeza-tests:
        condition: service_completed_successfully
      db:
        condition: service_started

  # ========================================
  #  FIRMEZA CLIENT (React Frontend)
  # ========================================
  firmeza-client:
    build:
      context: ./firmeza-client
      dockerfile: Dockerfile
    container_name: firmeza-client
    ports:
      - "3000:80"
    depends_on:
      firmeza-tests:
        condition: service_completed_successfully
      firmeza-api:
        condition: service_started

volumes:
  postgres_data:
